+++
title = "Groovy Amazon DynamoDB Simple Example"
date = 2012-01-22T09:43:00Z
updated = 2012-01-22T09:43:28Z
tags = ["Code"]
blogimport = true 
[author]
	name = "Sean Wesenberg"
	uri = "https://plus.google.com/111523202047342274226"
+++

The following is a two class example of Amazon's DynamoDB. The first class is just a Dao (yes, I still prefer Daos over ARs).<br /><br /><br /><pre class="brush:java">package wookets.dynamo<br /><br />import com.amazonaws.auth.AWSCredentials<br />import com.amazonaws.auth.PropertiesCredentials<br />import com.amazonaws.services.dynamodb.AmazonDynamoDBClient<br />import com.amazonaws.services.dynamodb.model.AttributeValue<br />import com.amazonaws.services.dynamodb.model.ComparisonOperator<br />import com.amazonaws.services.dynamodb.model.DeleteItemRequest<br />import com.amazonaws.services.dynamodb.model.DeleteItemResult<br />import com.amazonaws.services.dynamodb.model.GetItemRequest<br />import com.amazonaws.services.dynamodb.model.GetItemResult<br />import com.amazonaws.services.dynamodb.model.Key<br />import com.amazonaws.services.dynamodb.model.PutItemRequest<br />import com.amazonaws.services.dynamodb.model.PutItemResult<br /><br />class DynamoDao {<br />  <br />  AmazonDynamoDBClient client<br />  <br />  DynamoDao() {<br />    InputStream credentialsAsStream = Thread.currentThread().getContextClassLoader().getResourceAsStream("AwsCredentials.properties");<br />    AWSCredentials credentials = new PropertiesCredentials(credentialsAsStream);<br />    client = new AmazonDynamoDBClient(credentials);<br />  }<br />  <br />  // save<br />  def save(Object resource) {<br />    String tableName = resource._type<br />    if(resource._type == null) {<br />      throw new RuntimeException("You need to specify a _type to be able to save data under")<br />    }<br />    <br />    def item = [:]<br />    resource.each { key, value -&gt;<br />      if(key == "_type") return;<br />      if(value instanceof Number) {<br />        item.put(key, new AttributeValue().withN(value))<br />      } else if(value instanceof String) {<br />        item.put(key, new AttributeValue().withS(value))<br />      } else if(value instanceof List) {<br />        if(value[0] instanceof Number) {<br />          item.put(key, new AttributeValue().withNS(value))<br />        } else if(value[0] instanceof String) {<br />          item.put(key, new AttributeValue().withSS(value))<br />        }<br />      } else {<br />        throw new RuntimeException("Unsupported data type for property ${resource._type}.${key}")<br />      }<br />    }<br />    <br />    PutItemRequest putItemRequest = new PutItemRequest().withTableName(tableName).withItem(item)<br />    PutItemResult result = client.putItem(putItemRequest)<br />  }<br />  <br />  // read<br />  def load(String resourceType, String resourceId) {<br />    Key lookupKey = new Key().withHashKeyElement(new AttributeValue().withS(resourceId))<br />    GetItemRequest getItemRequest = new GetItemRequest().withTableName(resourceType).withKey(lookupKey)<br />    <br />    def item = [_type: resourceType, id: resourceId]<br />    GetItemResult result = client.getItem(getItemRequest);<br />    result.item.each { propName, value -&gt;<br />      if(value.getS() != null) {<br />        item[propName] = value.getS()<br />      } else if(value.getN() != null) {<br />        item[propName] = value.getN()<br />      } else if(value.getSS() != null) {<br />        item[propName] = value.getSS()<br />      } else if(value.getNS() != null) {<br />        item[propName] = value.getNS()<br />      }<br />    }<br />    return item<br />  }<br />  <br />  // delete<br />  def delete(String resourceType, String resourceId) {<br />    Key key = new Key().withHashKeyElement(new AttributeValue().withS(resourceId));<br />    DeleteItemRequest deleteItemRequest = new DeleteItemRequest().withTableName(resourceType).withKey(key)<br />    DeleteItemResult result = client.deleteItem(deleteItemRequest);<br />  }<br />  <br />}<br /><br /></pre><br /><br />The next class is the test harness.  <br /><pre class="brush:java">package test.dynamo;<br /><br />import static org.junit.Assert.*<br /><br />import java.text.SimpleDateFormat<br /><br />import org.junit.Test<br /><br />import wookets.dynamo.DynamoDao<br /><br />class TestDynamoDao {<br />  <br />  DynamoDao dynamoDao = new DynamoDao()<br />  <br />  static SimpleDateFormat dateFormatter = new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss.SSS'Z'");<br />  <br />  @Test<br />  void testSave() {<br />    def mock = [_type:"dynamomock", id: "MOCK1", name: "Namer", lister: ["Some1", "Like", "U"]]<br />    dynamoDao.save(mock)<br />  }<br />  <br />  @Test<br />  void testLoad() {<br />    def mock = dynamoDao.load("dynamomock", "MOCK1")<br />    mock.each { prop, value -&gt;<br />      print "${prop}: ${value}, "<br />    }<br />    println ""<br />  }<br />  <br />  @Test <br />  void testDelete() {<br />    dynamoDao.delete("dynamomock", "MOCK1")<br />  }<br />  <br />  @Test<br />  void testSaveAll() {<br />    dynamoDao.save([_type:"dynamomock", id: "MOCK1", name: "Namer"])<br />    dynamoDao.save([_type:"dynamomock", id: "MOCK2", name: "Namer2"])<br />    dynamoDao.save([_type:"dynamomock", id: "MOCK3", name: "Namer3"])<br />    dynamoDao.save([_type:"dynamomock", id: "MOCK4", name: "Namer4"])<br />    dynamoDao.save([_type:"dynamomock", id: "MOCK5", name: "Namer5"])<br />  }<br />  @Test<br />  void testLoadAll() {<br />    ["MOCK1", "MOCK2", "MOCK3", "MOCK4", "MOCK5"].each {<br />      def mock = dynamoDao.load("dynamomock", it)<br />      mock.each { prop, value -&gt;<br />        print "${prop}: ${value}, "<br />      }<br />      println ""<br />    }<br />  }<br />}<br /><br /></pre><br />Obviously this is a simple use case, but might help you in your travels...<br /><br />Btw, the properties (credentials file) looks like...<br /> <br /><div class="p2"><span class="s1">secretKey=</span></div><div class="p2"><span class="s1">accessKey=</span></div><br /><br /><br />
