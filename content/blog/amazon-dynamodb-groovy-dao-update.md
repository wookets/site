+++
title = "Amazon DynamoDB Groovy DAO Update"
date = 2012-01-25T11:44:00Z
updated = 2012-01-25T11:45:40Z
tags = ["Code"]
blogimport = true 
[author]
	name = "Sean Wesenberg"
	uri = "https://plus.google.com/111523202047342274226"
+++

Here is a an update version of the DAO from the previous post. I added update methods (very useful)...<br /><br />Next I will be working on some relationship type logic. Meaning, having a table that holds relationships and specifying you want those relationships (a list of ids) that will query that, then query the actual keys table and return the objects you want...<br /><br />Sorry about not posting on Github. Maybe one day I'll get it up there.<br /><br /><pre class="brush:java">package wookets.dynamo<br /><br />import groovy.util.logging.Log4j<br /><br />import org.springframework.stereotype.Repository<br /><br />import wookets.util.DateUtil<br />import wookets.util.ResourceTypeUtil<br /><br />import com.amazonaws.auth.AWSCredentials<br />import com.amazonaws.auth.PropertiesCredentials<br />import com.amazonaws.services.dynamodb.AmazonDynamoDBClient<br />import com.amazonaws.services.dynamodb.model.AttributeAction<br />import com.amazonaws.services.dynamodb.model.AttributeValue<br />import com.amazonaws.services.dynamodb.model.AttributeValueUpdate<br />import com.amazonaws.services.dynamodb.model.DeleteItemRequest<br />import com.amazonaws.services.dynamodb.model.DeleteItemResult<br />import com.amazonaws.services.dynamodb.model.GetItemRequest<br />import com.amazonaws.services.dynamodb.model.GetItemResult<br />import com.amazonaws.services.dynamodb.model.Key<br />import com.amazonaws.services.dynamodb.model.PutItemRequest<br />import com.amazonaws.services.dynamodb.model.PutItemResult<br />import com.amazonaws.services.dynamodb.model.ReturnValue<br />import com.amazonaws.services.dynamodb.model.UpdateItemRequest<br />import com.amazonaws.services.dynamodb.model.UpdateItemResult<br /><br />@Log4j<br />@Repository<br />class DynamoDao {<br />  <br />  AmazonDynamoDBClient client<br />  <br />  DynamoDao() {<br />    InputStream credentialsAsStream = Thread.currentThread().getContextClassLoader().getResourceAsStream("AwsCredentials.properties");<br />    AWSCredentials credentials = new PropertiesCredentials(credentialsAsStream);<br />    client = new AmazonDynamoDBClient(credentials);<br />  }<br />  <br />  // read<br />  def load(Object resourceType, String resourceId) {<br />    log.debug "Loading ${resourceType}::${resourceId}"<br />    <br />    String tableName = ResourceTypeUtil.resolveType(resourceType)<br />    GetItemRequest request = new GetItemRequest(tableName, new Key(toDynamo(resourceId)))<br />    GetItemResult result = client.getItem(request)<br />    <br />    def obj = resourceType instanceof Class ? resourceType.newInstance() : [_type: tableName] // return typed or dynamic<br />    result.item.each { String prop, AttributeValue val -&gt;<br />      obj[prop] = fromDynamo(val)<br />    }<br />    return obj<br />  }<br />  <br />  // save<br />  def save(Object resource) {<br />    log.debug "Saving ${resource}"<br />    <br />    def item = [:] // item to save<br />    if(resource.class == null) { // dynamic object<br />      resource.each { String prop, Object val -&gt;<br />        if(prop == "_type") return; // strip out '_type'<br />        if(val == null) return; // dont waste space with null values<br />        item[prop] = toDynamo(val)<br />      }<br />    } else { // typed object<br />      resource.properties.each { String prop, Object val -&gt;<br />        if(prop == "class") return; // strip out java added properties<br />        if(prop == "metaClass") return; // strip out groovy added properties<br />        if(val == null) return; // we don't support storing nulls<br />        item[prop] = toDynamo(val)<br />      }<br />    }<br />    <br />    String tableName = ResourceTypeUtil.resolveType(resource) // table name<br />    PutItemRequest request = new PutItemRequest(tableName, item)<br />    PutItemResult result = client.putItem(request)<br />  }<br />  <br />  // delete<br />  def delete(Object resourceType, String resourceId) {<br />    log.debug "Deleting ${resourceType}::${resourceId}"<br />    <br />    String tableName = ResourceTypeUtil.resolveType(resourceType)<br />    DeleteItemRequest request = new DeleteItemRequest(tableName, new Key(toDynamo(resourceId)))<br />    DeleteItemResult result = client.deleteItem(request)<br />  }<br />  <br />  // update<br />  def addToProperty(Object resourceType, String resourceId, String propertyName, Object propertyValue) {<br />    log.debug "Adding ${resourceType} - ${resourceId} - ${propertyName} - ${propertyValue}"<br />    <br />    String tableName = ResourceTypeUtil.resolveType(resourceType)<br />    Key key = new Key(toDynamo(resourceId))<br />    def updateItems = new HashMap<string, attributevalueupdate="">()<br />    <br />    updateItems.put(propertyName, new AttributeValueUpdate(toDynamo(propertyValue), AttributeAction.ADD))<br />    UpdateItemRequest request = new UpdateItemRequest(tableName, key, updateItems);          <br />    UpdateItemResult result = client.updateItem(request);<br />  }<br />  <br />  def replaceProperty(Object resourceType, String resourceId, String propertyName, Object propertyValue) {<br />    log.debug "Replacing ${resourceType} - ${resourceId} - ${propertyName} - ${propertyValue}"<br />    <br />    String tableName = ResourceTypeUtil.resolveType(resourceType)<br />    Key key = new Key(toDynamo(resourceId))<br />    def updateItems = new HashMap<string, attributevalueupdate="">()<br />    <br />    updateItems.put(propertyName, new AttributeValueUpdate(toDynamo(propertyValue), AttributeAction.PUT))<br />    UpdateItemRequest request = new UpdateItemRequest(tableName, key, updateItems);<br />    UpdateItemResult result = client.updateItem(request);<br />  }<br />  <br />  def removeFromProperty(Object resourceType, String resourceId, String propertyName, Object propertyValue) {<br />    log.debug "Removing ${resourceType} - ${resourceId} - ${propertyName} - ${propertyValue}"<br />    <br />    String tableName = ResourceTypeUtil.resolveType(resourceType)<br />    Key key = new Key(toDynamo(resourceId))<br />    def updateItems = new HashMap<string, attributevalueupdate="">()<br />    <br />    updateItems.put(propertyName, new AttributeValueUpdate(toDynamo(propertyValue), AttributeAction.DELETE))<br />    UpdateItemRequest request = new UpdateItemRequest(tableName, key, updateItems)<br />    UpdateItemResult result = client.updateItem(request)<br />  }<br />  <br />  def removeProperty(Object resourceType, String resourceId, String propertyName) {<br />    log.debug "Removing ${resourceType} - ${resourceId} - ${propertyName}"<br />    <br />    String tableName = ResourceTypeUtil.resolveType(resourceType)<br />    String hashKey = resourceId<br />    <br />    def updateItems = new HashMap<string, attributevalueupdate="">()<br />    Key key = new Key().withHashKeyElement(new AttributeValue().withS(hashKey))<br />    <br />    updateItems.put(propertyName, new AttributeValueUpdate().withAction(AttributeAction.DELETE));<br />    def updateItemRequest = new UpdateItemRequest().withTableName(tableName).withKey(key).withAttributeUpdates(updateItems);<br />    UpdateItemResult result = client.updateItem(updateItemRequest);<br />  }<br />  <br />  // private helper methods<br />  <br />  private AttributeValue toDynamo(Object value) {<br />    if(value instanceof Number) { // number support<br />      return new AttributeValue().withN(value)<br />    } else if(value instanceof String) { // string support<br />      return new AttributeValue().withS(value)<br />    } else if(value instanceof List) { // list support<br />      if(value[0] instanceof Number) { // number list support<br />        return new AttributeValue().withNS(value)<br />      } else if(value[0] instanceof String) { // string list support<br />        return new AttributeValue().withSS(value)<br />      }<br />    } else if(value instanceof Boolean) { // boolean support<br />      return new AttributeValue().withS(value ? "bool:true" : "bool:false")<br />    } else if(value instanceof Date) { // date support<br />      return new AttributeValue().withS("date:" + DateUtil.dateFormatter.format(value))<br />    } else {<br />      throw new RuntimeException("Unsupported data type for value ${value}")<br />    }<br />  }<br />  private Object fromDynamo(AttributeValue value) {<br />    if(value.getS() != null) {<br />      String val = value.getS()<br />      if(val == "bool:true") { // boolean support<br />        return true<br />      } else if(val == "bool:false") {<br />        return false<br />      } else if(val?.startsWith("date:")) { // date support<br />        return DateUtil.dateFormatter.parse(val.substring(5))<br />      } else { // string support<br />        return val<br />      }<br />    } else if(value.getN() != null) { // number support<br />      return value.getN()<br />    } else if(value.getSS() != null) { // set of strings support<br />      return value.getSS()<br />    } else if(value.getNS() != null) { // set of numbers support<br />      return value.getNS()<br />    }<br />  }<br />}<br /></pre><br /><br /><br /><br /><br />
